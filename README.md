# VGM Player for RC2014 Z80 Computer

A player for VGM files ported to the RC2014 Z80 computer.

**This is a port of the original VGM player for Amstrad CPC to work with RC2014 systems.**

## Credits

**Original Authors**: Shinra team - PulkoMandy, OffseT and Zik  
**Original Project**: https://framagit.org/shinra/vgmplay  
**RC2014 Port**: jduraes

## RC2014 Port Status

ðŸš§ **Work in Progress** - This is currently being ported from the original Amstrad CPC version to work with RC2014 systems.

## Original Description

This can play OPL1, OPL2 and OPL3 musics (YM3256, YM3812, YMF262) through the
OPL3LPT. It can also play AY music.

Some other musics can be used with the help of [vgm-conv](https://github.com/digital-sound-antiques/vgm-conv),
which can convert them to the supported ones. This allows for example to play
music from the MSX2 (normally using OPN2 + AY) on the OPL3.

With a bit more creativity (running old DOS tools in DosBox and capturing the
resulting register dumps) it is also possible to convert a few other formats
(Midi, SID, ...) for use with the OPL3.

The timing is synchronized on the CPC vertical blanking (50Hz) or on the interrupts
(300Hz). This is much less precise than the timing of the VGM files (44100Hz),
but seems good enough to play most sounds. Use of the Amstrad Plus raster interrupt
may allow for more precision. Unfortunately, AY lists can be used only with the
AY, no other soundchip can enjoy the DMA capabilities. The code rounds down the
waiting to the previous interrupt, but accumulates the error and adds it to later
delays. Since VGM files are usually generated by dumping the data from running
code, there will often be a lot of small delays between register writes. These
could probably be ignored to optimize things a bit. However, this is probably
easier to do in a pre-processing step rather than in the Z80 player. I will let
you experiment with the VGM format if you want to do such things.

Currently there is no compression of the VGM files. I don't want to implement a
full gzip decompressor so I need to figure out something simpler that can be
used as a stream easily (to unpack a few frames ahead, complete songs usually won't
fit in memory otherwise).

The header is also blindly skipped. This will create problems on early versions
of VGM files which have a smaller header, or later ones which have a larger one.

To maximize memory space usage, the player currently is loaded with the LD RSX
from the Arkos ROM (but can be adjusted to use LOAD from Utopia as well). It's
possible to play files up to about 38K, above that, some important things in
memory are overwritten and you get a crash and no music. Of course this could be
easily raised to 63K or so using the banks (or more if implementing bank switching
during replay, I guess?)

Unsupported commands in the VGM data are printed as ASCII chars. If something
is printed and the music is not sounding correctly, probably your file uses
not implemented commands.

## Supported VGM Commands

The following commands are available:

- 5A - Write to OPL2 register
- 5B - Write to OPL1 register
- 5E - Write to OPL3 register in bank 1
- 5F - Write to OPL3 register in bank 2
- 61 - Variable delay
- 62 - 1/60s delay
- 63 - 1/50s delay
- 66 - End of stream
- 70 to 7F - Short variable delay
- A0 - Write to AY3 register

## Technical Notes

The player uses CALLs BD19 (for synchronization), BB5A (for printing unknown
commands), and BD34 (write to AY). It also changes the border color to show
CPU load, and uses HALTs to position itself somewhere in the middle of the
display. This is all easily replaced or removed.

The player uses registers HL (song pointer), BC (pointer to OPL3), and IY
(time delay residue accumulator). These can easily be replaced by variables
or reloaded as needed instead to have something easier to mix with other code.

## RC2014 Adaptations Needed

- [ ] Adapt CPC-specific BIOS calls to CP/M or RC2014 monitor calls
- [ ] Update I/O port addresses for RC2014 sound cards
- [ ] Modify timing routines for RC2014 interrupt system
- [ ] Test with RC2014 OPL3 and AY sound cards
